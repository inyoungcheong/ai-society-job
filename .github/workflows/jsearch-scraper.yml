name: JSearch Job Scraper

on:
  schedule:
    # Run twice a week: Monday and Thursday at 9:00 UTC (18:00 KST)
    - cron: '0 9 * * 1,4'
  workflow_dispatch:  # Allow manual trigger
  push:
    paths:
      - 'j_scraper.py'
      - '.github/workflows/jsearch-scraper.yml'

# Add explicit permissions
permissions:
  contents: write
  actions: read

jobs:
  scrape-jobs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
        
    - name: Run JSearch scraper
      env:
        RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
      run: |
        python j_scraper.py
        
    - name: Check results
      run: |
        if [ -f "data/jsearch_jobs.json" ]; then
          echo "âœ… jsearch_jobs.json created successfully"
          echo "ğŸ“Š File size: $(du -h data/jsearch_jobs.json | cut -f1)"
          echo "ğŸ”¢ Job count: $(python -c "import json; data=json.load(open('data/jsearch_jobs.json')); print(data['metadata']['total_jobs'])")"
          echo "ğŸŒ API calls used: $(python -c "import json; data=json.load(open('data/jsearch_jobs.json')); print(data['metadata']['api_calls_used'])")"
        else
          echo "âŒ jsearch_jobs.json not found!"
          exit 1
        fi
        
    - name: Sync with remote and push results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
        # ìµœì‹  ë¸Œëœì¹˜ fetch
        git fetch origin main
    
        # ë³€ê²½ì‚¬í•­ ìŠ¤í…Œì´ì§• ë° ì»¤ë°‹
        git add data/
        if ! git diff --staged --quiet; then
          git commit -m "Update job data: $(date '+%Y-%m-%d %H:%M UTC')"
        fi
    
        # main ë¸Œëœì¹˜ì™€ fast-forward ë³‘í•©
        git pull origin main --no-rebase --no-edit || true
    
        git push origin main
