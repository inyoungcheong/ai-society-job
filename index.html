<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI & Society Global Job Board</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            min-height: 100vh;
            color: #111827;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin: 3rem auto 3rem auto;
            padding-top: 2rem;
            color: #111827;
            max-width: 800px;
        }

        .logo-symbol {
            font-size: 2rem;
            color: #06b6d4;
            margin-bottom: 1rem;
            letter-spacing: 0.5rem;
        }

        .header h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.8rem;
            margin-bottom: 1rem;
            font-weight: 600;
            color: #111827;
            letter-spacing: -0.02em;
        }

        .header p {
            font-size: 1.1rem;
            color: #6b7280;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.7;
        }

        .stats-compact {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(6, 182, 212, 0.08);
            margin-bottom: 2rem;
            text-align: center;
            border: 1px solid rgba(6, 182, 212, 0.1);
        }

        .stats-inline {
            font-size: 1.1rem;
            color: #111827;
            font-weight: 500;
        }

        .stats-inline .stat-number {
            font-weight: 700;
            color: #06b6d4;
        }

        .filters {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(6, 182, 212, 0.08);
            margin-bottom: 2rem;
            border: 1px solid rgba(6, 182, 212, 0.1);
        }

        .filters h3 {
            margin-bottom: 1rem;
            color: #111827;
            font-weight: 600;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        select, input {
            padding: 0.75rem;
            border: 2px solid #d1d5db;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #06b6d4;
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }

        .search-btn {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.25);
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(6, 182, 212, 0.3);
            background: linear-gradient(135deg, #0891b2, #0e7490);
        }

        .jobs-container {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(6, 182, 212, 0.08);
            overflow: hidden;
            border: 1px solid rgba(6, 182, 212, 0.1);
        }

        .jobs-header {
            background: #f8fafc;
            padding: 1.5rem;
            border-bottom: 1px solid rgba(6, 182, 212, 0.1);
        }

        .jobs-header h3 {
            margin-bottom: 1rem;
            color: #111827;
            font-weight: 600;
        }

        .sort-options {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .sort-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #d1d5db;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .sort-btn.active {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: white;
            border-color: #0891b2;
            box-shadow: 0 2px 8px rgba(6, 182, 212, 0.25);
        }

        .sort-btn:hover:not(.active) {
            border-color: #06b6d4;
            background: #f1f5f9;
            color: #0e7490;
        }

        .job-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .job-item {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .job-item:hover {
            background: #fefce8;
            border-left: 4px solid #06b6d4;
            padding-left: calc(1.5rem - 4px);
        }

        .job-item:last-child {
            border-bottom: none;
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }

        .job-info {
            flex: 1;
        }

        .job-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }

        .job-title a {
            color: #111827;
            text-decoration: none;
            transition: color 0.2s ease;
            cursor: pointer;
        }

        .job-title a:hover {
            color: #06b6d4;
            text-decoration: underline;
        }

        .job-company {
            color: #06b6d4;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .job-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .job-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .tag {
            background: #f1f5f9;
            color: #06b6d4;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            border: 1px solid rgba(6, 182, 212, 0.2);
        }

        .gemini-badge {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: white;
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            margin-left: 0.5rem;
            font-weight: 500;
        }
        
        .gemini-reasoning {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #f8fafc;
            border-left: 3px solid #06b6d4;
            border-radius: 0 8px 8px 0;
            font-size: 0.85rem;
            color: #475569;
            font-style: italic;
        }
        
        .tag.confidence-high { background: #dcfce7; color: #166534; border-color: rgba(22, 101, 52, 0.2); }
        .tag.confidence-medium { background: #fef3c7; color: #92400e; border-color: rgba(146, 64, 14, 0.2); }
        .tag.confidence-low { background: #fee2e2; color: #991b1b; border-color: rgba(153, 27, 27, 0.2); }
        
        .tag.topic { background: #ede9fe; color: #6b21a8; border-color: rgba(107, 33, 168, 0.2); }
        .tag.remote { background: #ecfdf5; color: #059669; border-color: rgba(5, 150, 105, 0.2); }
        
        .tag.source-linkedin { background: #dbeafe; color: #1e40af; border-color: rgba(30, 64, 175, 0.2); }
        .tag.source-jsearch { background: #fef3c7; color: #d97706; border-color: rgba(217, 119, 6, 0.2); }
        .tag.source-academic { background: #f3e8ff; color: #7c2d12; border-color: rgba(124, 45, 18, 0.2); }
        .tag.source-other { background: #f1f5f9; color: #475569; border-color: rgba(71, 85, 105, 0.2); }

        .tag.faculty { background: #f0f9ff; color: #0369a1; border-color: rgba(3, 105, 161, 0.2); }
        .tag.industry { background: #fff7ed; color: #ea580c; border-color: rgba(234, 88, 12, 0.2); }
        .tag.nonprofit { background: #fdf2f8; color: #be185d; border-color: rgba(190, 24, 93, 0.2); }
        .tag.government { background: #eff6ff; color: #2563eb; border-color: rgba(37, 99, 235, 0.2); }
        .tag.international { background: #f5f3ff; color: #7c3aed; border-color: rgba(124, 58, 237, 0.2); }

        .tag.law { background: #fef7ff; color: #a21caf; border-color: rgba(162, 28, 175, 0.2); }
        .tag.policy { background: #f0f9ff; color: #0369a1; border-color: rgba(3, 105, 161, 0.2); }
        .tag.technical { background: #fff1f2; color: #dc2626; border-color: rgba(220, 38, 38, 0.2); }
        .tag.research { background: #f0fdf4; color: #16a34a; border-color: rgba(22, 163, 74, 0.2); }

        .relevance-score {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: 700;
            font-size: 0.9rem;
            min-width: 60px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(6, 182, 212, 0.25);
        }

        .loading, .no-results {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .last-update {
            text-align: center;
            margin-top: 2rem;
            color: #6b7280;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
            }
            
            .job-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .job-meta {
                flex-direction: column;
                gap: 0.25rem;
            }

            .stats-inline {
                font-size: 1rem;
                line-height: 1.8;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-symbol">‚ú¶ ‚úß ‚ú¶</div>
            <h1>AI & Society Global Job Board</h1>
            <p>Faculty, Industry, Non-profit, Government & International positions in AI ethics, policy, law, and societal impacts</p>
        </div>

        <!-- Compact Stats Section -->
        <div class="stats-compact">
            <div class="stats-inline" id="stats-display">
                üìä <span class="stat-number">--</span> Total Jobs ‚Ä¢ 
                <span class="stat-number">--</span> Faculty ‚Ä¢ 
                <span class="stat-number">--</span> Industry ‚Ä¢ 
                <span class="stat-number">--</span> Government ‚Ä¢ 
                <span class="stat-number">--</span> Non-profit ‚Ä¢ 
                <span class="stat-number">--</span> International
            </div>
        </div>

        <div class="filters">
            <h3>üîç Filter Jobs</h3>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="job-type">Job Type</label>
                    <select id="job-type">
                        <option value="all">All Types</option>
                        <option value="faculty">Faculty</option>
                        <option value="industry">Industry</option>
                        <option value="nonprofit">Non-profit</option>
                        <option value="government">Government</option>
                        <option value="international">International</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="category">Category</label>
                    <select id="category">
                        <option value="all">All Categories</option>
                        <option value="law">Law</option>
                        <option value="policy">Policy</option>
                        <option value="technical">Technical</option>
                        <option value="research">Research</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="location">Location</label>
                    <input type="text" id="location" placeholder="e.g., Remote, California">
                </div>
                <div class="filter-group">
                    <label for="keyword">Keywords</label>
                    <input type="text" id="keyword" placeholder="e.g., machine learning, ethics">
                </div>
                <div class="filter-group">
                    <button class="search-btn" onclick="applyFilters()">Search</button>
                </div>
            </div>
        </div>

        <div class="jobs-container">
            <div class="jobs-header">
                <h3>üìã Job Listings</h3>
                <div class="sort-options">
                    <button class="sort-btn active" onclick="sortJobs('relevance', event)">Relevance</button>
                    <button class="sort-btn" onclick="sortJobs('date', event)">Date</button>
                    <button class="sort-btn" onclick="sortJobs('company', event)">Company</button>
                </div>
            </div>
            
            <div class="job-list" id="job-list">
                <div class="loading">
                    <p>üîÑ Loading jobs...</p>
                </div>
            </div>
        </div>

        <div class="last-update">
            Last updated: <span id="last-update">--</span>
        </div>
    </div>

    <script>
        let allJobs = [];
        let filteredJobs = [];
        let currentSort = 'relevance';

        // Load jobs from integrated master file first, then fallback to individual sources
        async function loadJobs() {
            try {
                let allJobsFromSources = [];
                let dataSource = 'unknown';
                
                // Priority 1: Load integrated master file
                try {
                    const masterResponse = await fetch('data/all_jobs_integrated.json');
                    const masterData = await masterResponse.json();
                    if (masterData.jobs && masterData.jobs.length > 0) {
                        allJobsFromSources = masterData.jobs;
                        dataSource = 'integrated';
                        console.log(`‚úÖ Loaded ${masterData.jobs.length} jobs from integrated master file`);
                        
                        // Update with integrated stats if available
                        if (masterData.stats) {
                            updateStats(masterData.stats);
                        }
                        if (masterData.metadata) {
                            updateLastUpdate(masterData.metadata.last_update || new Date().toISOString());
                        }
                        
                        // Show data source info
                        showDataSourceInfo(masterData);
                    }
                } catch (error) {
                    console.log('Integrated master file not available, trying individual sources...');
                }
                
                // Fallback: Load from individual sources if master file not available
                if (allJobsFromSources.length === 0) {
                    console.log('üîÑ Loading from individual data sources...');
                    
                    // Load from JSearch data
                    try {
                        const jsearchResponse = await fetch('data/jsearch_gemini_jobs.json');
                        const jsearchData = await jsearchResponse.json();
                        if (jsearchData.jobs) {
                            allJobsFromSources = allJobsFromSources.concat(jsearchData.jobs);
                            console.log(`Loaded ${jsearchData.jobs.length} jobs from JSearch`);
                        }
                    } catch (error) {
                        console.log('JSearch data not available');
                    }
                    
                    // Also try the legacy filename
                    try {
                        const jsearchLegacyResponse = await fetch('data/jsearch_jobs.json');
                        const jsearchLegacyData = await jsearchLegacyResponse.json();
                        if (jsearchLegacyData.jobs) {
                            allJobsFromSources = allJobsFromSources.concat(jsearchLegacyData.jobs);
                            console.log(`Loaded ${jsearchLegacyData.jobs.length} jobs from JSearch (legacy)`);
                        }
                    } catch (error) {
                        console.log('JSearch legacy data not available');
                    }
                    
                    // Load from general scraper data
                    try {
                        const generalResponse = await fetch('data/jobs.json');
                        const generalData = await generalResponse.json();
                        if (generalData.jobs) {
                            allJobsFromSources = allJobsFromSources.concat(generalData.jobs);
                            console.log(`Loaded ${generalData.jobs.length} jobs from general scraper`);
                        }
                    } catch (error) {
                        console.log('General scraper data not available');
                    }
                    
                    // Load from LinkedIn data
                    try {
                        const linkedinResponse = await fetch('data/linkedin_gemini_jobs.json');
                        const linkedinData = await linkedinResponse.json();
                        if (linkedinData.jobs) {
                            allJobsFromSources = allJobsFromSources.concat(linkedinData.jobs);
                            console.log(`Loaded ${linkedinData.jobs.length} jobs from LinkedIn`);
                        }
                    } catch (error) {
                        console.log('LinkedIn data not available');
                    }
                    
                    // Load from Academic/Gemini data
                    try {
                        const academicResponse = await fetch('data/ajo_gemini_jobs.json');
                        const academicData = await academicResponse.json();
                        if (academicData.jobs) {
                            allJobsFromSources = allJobsFromSources.concat(academicData.jobs);
                            console.log(`Loaded ${academicData.jobs.length} jobs from Academic`);
                        }
                    } catch (error) {
                        console.log('Academic data not available');
                    }
                    
                    dataSource = 'individual';
                }
                
                // Remove duplicates if loading from individual sources
                let uniqueJobs;
                if (dataSource === 'individual') {
                    uniqueJobs = removeDuplicateJobs(allJobsFromSources);
                    updateStats(calculateCombinedStats(uniqueJobs));
                    updateLastUpdate(new Date().toISOString());
                } else {
                    uniqueJobs = allJobsFromSources; // Already processed in master file
                }
                
                allJobs = uniqueJobs;
                filteredJobs = [...allJobs];
                renderJobs();
                
                console.log(`üéØ Total jobs loaded: ${allJobs.length} (source: ${dataSource})`);
                
            } catch (error) {
                console.error('Error loading jobs:', error);
                loadDemoData();
            }
        }
        
        // Show data source information
        function showDataSourceInfo(masterData) {
            if (masterData.stats && masterData.stats.sources) {
                const sources = masterData.stats.sources;
                console.log('üìä Data sources breakdown:');
                console.log(`   Academic: ${sources.academic || 0}`);
                console.log(`   JSearch: ${sources.jsearch || 0}`);
                console.log(`   LinkedIn: ${sources.linkedin || 0}`);
            }
        }
        
        // Remove duplicate jobs based on source URL
        function removeDuplicateJobs(jobs) {
            const seen = new Set();
            return jobs.filter(job => {
                const key = job.source_url || `${job.title}-${job.company}`;
                if (seen.has(key)) {
                    return false;
                }
                seen.add(key);
                return true;
            });
        }
        
        // Calculate combined statistics
        function calculateCombinedStats(jobs) {
            const stats = {
                total: jobs.length,
                by_job_type: {},
                by_category: {},
                new_today: 0
            };
            
            const today = new Date().toISOString().split('T')[0];
            
            jobs.forEach(job => {
                // Count by job type
                const jobType = job.job_type || 'unknown';
                stats.by_job_type[jobType] = (stats.by_job_type[jobType] || 0) + 1;
                
                // Count by category
                const category = job.category || 'unknown';
                stats.by_category[category] = (stats.by_category[category] || 0) + 1;
                
                // Count new today
                if (job.posting_date === today) {
                    stats.new_today++;
                }
            });
            
            return stats;
        }

        // Demo data fallback
        function loadDemoData() {
            allJobs = [
                {
                    title: "AI Ethics Researcher",
                    company: "Stanford HAI",
                    location: "Stanford, CA, US",
                    job_type: "faculty",
                    category: "research",
                    description: "Research position focusing on AI ethics and societal impact...",
                    posting_date: "2025-07-20",
                    deadline: "2025-09-15",
                    source_url: "https://example.com/job1",
                    relevance_score: 95,
                    tags: ["AI Ethics", "Research", "Faculty"]
                },
                {
                    title: "AI Policy Analyst",
                    company: "Google",
                    location: "Mountain View, CA, US",
                    job_type: "industry",
                    category: "policy",
                    description: "Analyze AI policy implications for technology development...",
                    posting_date: "2025-07-19",
                    deadline: null,
                    source_url: "https://example.com/job2",
                    relevance_score: 88,
                    tags: ["Policy", "Analysis", "Industry"]
                },
                {
                    title: "AI Governance Specialist",
                    company: "OECD",
                    location: "Paris, France",
                    job_type: "international",
                    category: "policy",
                    description: "Develop international standards and guidelines for AI governance...",
                    posting_date: "2025-07-18",
                    deadline: "2025-09-05",
                    source_url: "https://example.com/job4",
                    relevance_score: 96,
                    tags: ["International", "AI Governance", "Policy"]
                },
                {
                    title: "Digital Rights Legal Counsel",
                    company: "Federal Trade Commission",
                    location: "Washington, DC, US",
                    job_type: "government",
                    category: "law",
                    description: "Legal counsel specializing in digital rights and AI regulation...",
                    posting_date: "2025-07-17",
                    deadline: "2025-08-25",
                    source_url: "https://example.com/job5",
                    relevance_score: 94,
                    tags: ["Legal", "Digital Rights", "Government"]
                }
            ];

            updateStats({
                total: 15,
                by_job_type: { faculty: 4, industry: 5, government: 2, international: 1, nonprofit: 3 }
            });
            
            updateLastUpdate("2025-07-25T12:00:00Z");
            filteredJobs = [...allJobs];
            renderJobs();
        }

        // Update statistics display - FIXED to include all job types
        function updateStats(stats) {
            const jobTypes = stats.by_job_type || {};
            const total = stats.total || stats.total_jobs || 0;
            const faculty = jobTypes.faculty || 0;
            const industry = jobTypes.industry || 0;
            const government = jobTypes.government || 0;
            const nonprofit = jobTypes.nonprofit || 0;
            const international = jobTypes.international || 0;

            document.getElementById('stats-display').innerHTML = `
                üìä <span class="stat-number">${total}</span> Total Jobs ‚Ä¢ 
                <span class="stat-number">${faculty}</span> Faculty ‚Ä¢ 
                <span class="stat-number">${industry}</span> Industry ‚Ä¢ 
                <span class="stat-number">${government}</span> Government ‚Ä¢ 
                <span class="stat-number">${nonprofit}</span> Non-profit ‚Ä¢ 
                <span class="stat-number">${international}</span> International
            `;
        }

        // Update last update timestamp
        function updateLastUpdate(timestamp) {
            const date = new Date(timestamp);
            document.getElementById('last-update').textContent = date.toLocaleString('en-US');
        }

        // Render job listings with enhanced Gemini features
        function renderJobs() {
            const jobList = document.getElementById('job-list');
            
            if (filteredJobs.length === 0) {
                jobList.innerHTML = '<div class="no-results">No jobs match your search criteria.</div>';
                return;
            }

            const jobsHTML = filteredJobs.map(job => `
                <div class="job-item">
                    <div class="job-header">
                        <div class="job-info">
                            <div class="job-title">
                                <a href="${job.source_url}" target="_blank" rel="noopener noreferrer">
                                    ${job.title}
                                </a>
                                ${job.gemini_analyzed ? '<span class="gemini-badge">ü§ñ AI Analyzed</span>' : ''}
                            </div>
                            <div class="job-company">${job.company}</div>
                            <div class="job-meta">
                                <span>üåç ${job.location || 'Location TBD'}</span>
                                <span>üìÖ ${new Date(job.posting_date).toLocaleDateString('en-US')}</span>
                                ${job.deadline ? `<span>‚è∞ Deadline: ${new Date(job.deadline).toLocaleDateString('en-US')}</span>` : ''}
                                ${job.salary_info ? `<span>üí∞ ${job.salary_info}</span>` : ''}
                                ${job.career_level ? `<span>üëî ${job.career_level.charAt(0).toUpperCase() + job.career_level.slice(1)}</span>` : ''}
                            </div>
                            <div class="job-tags">
                                <span class="tag ${job.job_type}">${job.job_type}</span>
                                <span class="tag ${job.category}">${job.category}</span>
                                ${job.confidence ? `<span class="tag confidence-${job.confidence}">${job.confidence} confidence</span>` : ''}
                                ${job.key_topics ? job.key_topics.slice(0, 2).map(topic => `<span class="tag topic">${topic}</span>`).join('') : ''}
                                ${job.tags ? job.tags.slice(0, 2).map(tag => `<span class="tag">${tag}</span>`).join('') : ''}
                                ${job.is_remote ? '<span class="tag remote">Remote</span>' : ''}
                                ${getSourceBadge(job)}
                            </div>
                            ${job.gemini_reasoning ? `<div class="gemini-reasoning">ü§ñ ${job.gemini_reasoning.substring(0, 120)}...</div>` : ''}
                        </div>
                        <div class="relevance-score">${job.relevance_score || job.basic_relevance_score || 60}%</div>
                    </div>
                </div>
            `).join('');

            jobList.innerHTML = jobsHTML;
        }
        
        // Get source badge based on job data
        function getSourceBadge(job) {
            if (job.source_site === 'linkedin') {
                return '<span class="tag source-linkedin">LinkedIn</span>';
            } else if (job.source_site === 'google_jobs') {
                return '<span class="tag source-jsearch">Google Jobs</span>';
            } else if (job.source_site === 'academic_jobs_online') {
                return '<span class="tag source-academic">Academic</span>';
            } else if (job.source_site === '80000hours' || job.source_site === 'indeed') {
                return '<span class="tag source-other">Curated</span>';
            }
            return '';
        }

        // Apply filters
        function applyFilters() {
            const jobType = document.getElementById('job-type').value;
            const category = document.getElementById('category').value;
            const location = document.getElementById('location').value.toLowerCase();
            const keyword = document.getElementById('keyword').value.toLowerCase();

            filteredJobs = allJobs.filter(job => {
                return (jobType === 'all' || job.job_type === jobType) &&
                       (category === 'all' || job.category === category) &&
                       (location === '' || job.location.toLowerCase().includes(location)) &&
                       (keyword === '' || 
                        job.title.toLowerCase().includes(keyword) ||
                        job.description.toLowerCase().includes(keyword) ||
                        job.company.toLowerCase().includes(keyword));
            });

            sortJobs(currentSort);
        }

        // Sort jobs - FIXED to handle event target properly
        function sortJobs(type, event) {
            currentSort = type;
            
            // Update active sort button
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // If no event (called programmatically), find button by type
                document.querySelectorAll('.sort-btn').forEach(btn => {
                    if (btn.textContent.toLowerCase().includes(type)) {
                        btn.classList.add('active');
                    }
                });
            }

            switch(type) {
                case 'relevance':
                    filteredJobs.sort((a, b) => (b.relevance_score || b.basic_relevance_score || 60) - (a.relevance_score || a.basic_relevance_score || 60));
                    break;
                case 'date':
                    filteredJobs.sort((a, b) => new Date(b.posting_date) - new Date(a.posting_date));
                    break;
                case 'company':
                    filteredJobs.sort((a, b) => a.company.localeCompare(b.company));
                    break;
            }

            renderJobs();
        }

        // Initialize on page load
        window.addEventListener('load', loadJobs);
    </script>
</body>
</html>
